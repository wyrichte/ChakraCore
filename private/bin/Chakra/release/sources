!include $(PROJECT_ROOT)\platform.inc
!include $(JSCRIPT_ROOT)\jslib.inc

!if defined(_CHAKRA_UCRT_BUILD)
USE_UNICRT=1
USE_MSVCRT=1
USE_STL=1
STL_VER=STL_VER_CURRENT
!else
USE_NOTHROW_NEW=1
!endif

BUILD_FOR_CORESYSTEM=1
USE_DEFAULT_WIN32_LIBS=0
USE_UMBRELLA_LIBS=1
USE_64BIT_LINKER=1
LINK_TIME_CODE_GENERATION=1

!if !$(ARM64)
LINKER_FLAGS=$(LINKER_FLAGS) -d2:-pspeed1
!endif

USER_INCLUDES=$(JS_LIBS_PARSER_INC);$(OBJ_PATH)\..\..\..\dll\retail\$(O)

C_DEFINES =$(C_DEFINES) -DWINNT -DUNICODE -D_UNICODE -DRECYCLER_VISITED_HOST

DLLDEF_OBJECTS=$(DLLDEF_OBJECTS) \
    $(JS_LIBS_MEMPROTECTHEAP) \
    $(JS_LIBS_RECYCLERHEAP) \
    $(JS_LIBS_JSRT) \
    $(JS_LIBS_ENGINE) \
    $(JS_LIBS_JITSERVER) \

INCLUDES= \
    $(INCLUDES) \
    $(COREINCLUDES); \
    $(SDK_LIB_PATH); \
    $(SDK_INC_PATH); \
    $(COM_INC_PATH); \
    $(COM_INC_PATH)\winrt; \
    $(PROJECT_ROOT)\lib\inc; \
    $(PROJECT_OBJ_ROOT)\manifests\inbox\$(O); \
    $(COM_INC_PATH)\midlrt; \
    $(PROJECT_ROOT)\jscript\core\lib\jsrt; \
    $(PROJECT_OBJ_ROOT)\jscript\manifests\$(O); \
    $(MINWIN_PRIV_SDK_INC_PATH); \
    ..\; \

EDIT_AND_CONTINUE_SOURCES = \
        ..\EditTest.cpp \
        ..\ScriptEdit.cpp \
        ..\SemanticChange.cpp \


# Dependent Libraries
#   iedevtools_host_iel1_edge.lib:
#       LoadLatestPDM
#       ShouldUseLocalPDM
#
#   IESettings*, iertutilp.lib
#       SettingStore
#
#   CommonUtilityLibrary.lib:
#       _DoNotUseDirectly_CULprintf
#
#   PathCchApis.lib: (to avoid loading api-ms-win-core-path-l1-1-0.dll)
#       PathCchCombine  (used in iedevtools_host_iel1_edge.lib)
#       PatthCchAppend  (used in iedevtools_host_iel1_edge.lib)

LINKLIBS= \
    $(JS_LIBS_ENGINE) \
    $(JS_LIBS_JSRT) \
    $(JS_LIBS_WINRT) \
    $(JS_LINK_LIBS) \
    $(PROJECT_LIB_PATH)\iertutilp.lib \
    $(PROJECT_LIB_PATH)\EdgeSettingsApi.lib \
    $(PROJECT_LIB_PATH)\EdgeSettingsId.lib \
    $(MINCORE_PRIV_SDK_LIB_PATH)\pathcchapis.lib    \
    $(OBJECT_INETCORE_DIR)\lib\devtb\dtbhost_edge\$(O)\iedevtools_host_iel1_edge.lib \
    $(OBJECT_INETCORE_DIR)\lib\ScriptProjectionHost\iel3_edge\$(O)\ScriptProjectionHost_Edge_iel3.lib \
    $(ONECORESHELL_LIB_PATH)\commonutilitylibrary.lib \

TARGETLIBS= \
    $(ONECOREBASE_LIB_PATH)\appmodel\common\appmodel.common.lib \
    $(MINCORE_PRIV_SDK_LIB_PATH)\1.3\ext-ms-win-com-ole32-l1.lib \
    $(MINCORE_PRIV_SDK_LIB_VPATH)\ext-ms-win-rometadata-dispenser-l1.lib \
    $(MINCORE_PRIV_SDK_LIB_VPATH)\mincore_private.lib \
    $(MINCORE_SDK_LIB_PATH)\mincore_fw.lib    \
    $(MINCORE_SDK_LIB_VPATH)\api-ms-win-core-winrt-l1.lib \
    $(MINCORE_SDK_LIB_VPATH)\api-ms-win-ro-typeresolution-l1.lib \
    $(ONECORE_SDK_LIB_VPATH)\onecore.lib \
    $(SDK_LIB_PATH)\onecore_downlevel.lib \
    $(SDK_LIB_PATH)\ntdll.lib \
!if (!$(FREEBUILD))
    $(SDK_LIB_PATH)\dbghelp.lib \
!endif
    $(MINWIN_PRIV_SDK_LIB_PATH)\MicrosoftTelemetryAssertUM.lib \
    $(SDK_LIB_PATH)\icuuc.lib \
    $(SDK_LIB_PATH)\icuin.lib \


# Delay load
DELAYLOAD = \
    oleaut32.dll; \
    ole32.dll; \
    cryptsp.dll; \
    crypt32.dll; \
!IF "$(_NT_TARGET_VERSION)" == "$(_NT_TARGET_VERSION_WIN10_RS2)"
    api-ms-win-core-winrt-error-l1.dll; \
!endif
!if "$(JS_LANGUAGE_SERVICE)" != "1"
    api-ms-win-core-winrt-l1.dll; \
    api-ms-win-core-com-l1.dll; \
    api-ms-win-ro-typeresolution-l1.dll; \
    ext-ms-win-rometadata-dispenser-l1.dll; \
!endif

ALLOW_NT_STYLE_DLOAD_ERROR_HANDLER=1
DLOAD_ERROR_HANDLER=kernelbase.dll
# End delay load

TARGETNAME=chakra
TARGET_DESTINATION=retail
TARGETTYPE=DYNLINK

MUI=0
MUI_COMMENT=OS.16706276 requested removal of MUI because the resources aren't being localized

DLLDEF=$(OBJ_PATH)\$(O)\Chakra.def

SOURCES = \
    ..\chakra.rc  \
    ..\ChakraDllFunc.cpp \
    ..\ChakraVersionBuildCommit.cpp

RESOURCE_FILE=..\chakra.rc

PASS1_PUBLISH=\
    {$(OBJ_PATH)\$(O)\chakra.lib=$(SDK_LIB_PATH)\chakrart.lib}

PGI_LINK_FLAG=/GENPROFILE:MEMMAX=20971520

DOMAIN_TAGS=Browser
ENABLE_PGI_BVT=true
ENABLE_PGI=true

