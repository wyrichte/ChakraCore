<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <PropertyGroup>
    <!-- CFG is turned off for ARM for now -->
    <CFG Condition="'$(CFG)'=='' AND '$(Platform)'!='ARM'">true</CFG>
  </PropertyGroup>
  <ItemDefinitionGroup>
    <!-- ========= Microsoft.Build.Cpp.Default.props ========= -->
    <!-- These are already defined in Microsoft.Build.Cpp.Default.props, have it here too so that the non-Razzle build will be the same -->
    <Midl>      
      <StructMemberAlignment Condition="'%(Midl.StructMemberAlignment)' == ''">8</StructMemberAlignment>
      <DefaultCharType>Unsigned</DefaultCharType>

      <IdlType>Ole</IdlType>
      <!-- Default Idl type -->

      <!-- Force all MIDL compiles to be treated as English unless otherwise specified -->
      <LocaleID>1033</LocaleID>

      <!-- Disable the settings comment to make the headers more diff-able.  Only available in midl 8 -->
      <AdditionalOptions>%(AdditionalOptions) /no_settings_comment</AdditionalOptions>

      <!--Disable midl timestamps wherever possible-->
      <AdditionalOptions>%(AdditionalOptions) /no_stamp</AdditionalOptions>
      <SuppressStartupBanner>true</SuppressStartupBanner>
    </Midl>

    <ClCompile>
      <!-- ========= For IESettings.h/Banned.h ========= -->
      <AdditionalIncludeDirectories>%(AdditionalIncludeDirectories);$(PUBLIC_ROOT)\internal\inetcore\inc</AdditionalIncludeDirectories>
      <!-- ========= For CULHeapAllocHelpers.h (referenced in IESettings.h) ========= -->
      <AdditionalIncludeDirectories>%(AdditionalIncludeDirectories);$(PUBLIC_ROOT)\internal\shell\inc</AdditionalIncludeDirectories>

      <!-- ========= From inetcore\project.mk =========-->
      <PreprocessorDefinitions>%(PreprocessorDefinitions);CULDEBUG_USE_NTASSERT</PreprocessorDefinitions>

      <!-- ========= From tools\makefile.def ========= -->
      <AdditionalOptions>%(AdditionalOptions) /Yl$(TargetName) /Gw /d2AllowCompatibleILVersions /d2Zi+</AdditionalOptions>
      <!-- Disable __DATE__ and __TIME__ macro on fre to prevent screwing up servicing -->
      <AdditionalOptions Condition="'$(FreeBuild)'=='true'">%(AdditionalOptions) /d1nodatetime</AdditionalOptions>
      
      <!-- this is the default in the headers anyways, here just to be explicit -->
      <PreprocessorDefinitions>%(PreprocessorDefinitions);_USE_DECLSPECS_FOR_SAL=1</PreprocessorDefinitions>
      
      <!-- ========= From tools\<platform>mk.inc -->
      <!-- Force no_registry search for type libraries (we have #import mscorlib.tlb) -->
      <AdditionalOptions>%(AdditionalOptions) /d1import_no_registry</AdditionalOptions>
      <ProgramDataBaseFileName>$(IntDir)$(TargetName).pdb</ProgramDataBaseFileName>
      
      <!-- ========= From tools\armmk.inc ========= -->
      <AdditionalOptions Condition="'$(Platform)'=='ARM'">%(AdditionalOptions) /arch:VFPv3-D16 /Gs4096</AdditionalOptions>
      
      <!-- ========= From inetcore\jscript\project.mk ========= -->
      <PreprocessorDefinitions>%(PreprocessorDefinitions);NTBUILD;NOMINMAX;NO_SHLWAPI_ISOS;USE_EDGEMODE_JSRT</PreprocessorDefinitions>            
      <AdditionalOptions>%(AdditionalOptions) /Zm150</AdditionalOptions>
      <AdditionalOptions Condition="'$(Platform)'=='Win32'">%(AdditionalOptions) /d2noftol3</AdditionalOptions>
      <AdditionalOptions Condition="'$(Platform)'=='x64'">%(AdditionalOptions) /homeparams</AdditionalOptions>
      <EnableEnhancedInstructionSet Condition="'$(Platform)'=='Win32'">NoExtensions</EnableEnhancedInstructionSet>
      <!-- /W4 -->
      <WarningLevel>Level4</WarningLevel>
      <!-- /WX -->
      <TreatWarningAsError>true</TreatWarningAsError>
      <!-- /GR- -->
      <RuntimeTypeInfo>false</RuntimeTypeInfo>
      <!-- /Zi -->
      <DebugInformationFormat>ProgramDatabase</DebugInformationFormat>      
      <!-- /EHsc- -->
      <ExceptionHandling>SyncCThrow</ExceptionHandling>
      <!-- Some of our STDMETHOD can throw
           TODO: Code review STDMETHOD and separate out API that can throw and those that can't -->
      <PreprocessorDefinitions>%(PreprocessorDefinitions);COM_STDMETHOD_CAN_THROW</PreprocessorDefinitions>
      <!-- TODO: clean up 4267 -->
      <DisableSpecificWarnings>4100;4127;4267;4481</DisableSpecificWarnings>
      
      <!-- ========= Microsoft.Build.Cpp.props ========= -->
      <!-- These are already defined in Microsoft.Build.Cpp.props, have it here too so that the non-Razzle build will be the same -->
      <!-- /Gz -->
      <CallingConvention Condition="'$(Platform)'=='Win32'">StdCall</CallingConvention>

      <!-- ========= Microsoft.Build.Cpp.Default.props ========= -->
      <!-- These are already defined in Microsoft.Build.Cpp.Default.props, have it here too so that the non-Razzle build will be the same -->
      <!-- /Zc:wchar_t- -->
      <TreatWChar_tAsBuiltInType>false</TreatWChar_tAsBuiltInType>
      <!-- /Zp8 -->
      <StructMemberAlignment>8Bytes</StructMemberAlignment>      

      <!-- ========= Microsoft.Cl.Common.props defaults ========= -->
      <!-- /GS -->
      <BufferSecurityCheck>true</BufferSecurityCheck>
      <!-- No /RTC -->
      <BasicRuntimeChecks>Default</BasicRuntimeChecks>       
      <SmallerTypeCheck>false</SmallerTypeCheck>      

      <!-- ========= Other defaults ========= -->      
      <!-- /Gy -->
      <FunctionLevelLinking>true</FunctionLevelLinking>
      <!-- /GF -->
      <StringPooling>true</StringPooling>      
      <!-- /Zl -->
      <OmitDefaultLibName>true</OmitDefaultLibName>
      <!-- /MD -->
      <RuntimeLibrary>MultiThreadedDLL</RuntimeLibrary>

      <!-- Enable Minimal rebuild inside VS, we can expand it if it is worth while -->
      <MinimalRebuild>false</MinimalRebuild>
      <MinimalRebuild Condition="'$(BuildingInsideVisualStudio)'=='true'">true</MinimalRebuild>
      
      <!-- We don't use any metadata -->
      <AdditionalUsingDirectories />      
    </ClCompile>    
    <MASM>
      <!-- /Cx -->
      <PreserveIdentifierCase>3</PreserveIdentifierCase>
      <PreprocessorDefinitions>%(ClCompile.PreprocessorDefinitions)</PreprocessorDefinitions>
      <IncludePaths>%(ClCompile.AdditionalIncludeDirectories)</IncludePaths>
    </MASM>
    <Link>
      <!-- These are already defined in Microsoft.Build.Cpp.Default.props, have it here too so that the non-Razzle build will be the same -->      
      <TreatLinkerWarningAsErrors>true</TreatLinkerWarningAsErrors>
      <GenerateDebugInformation>true</GenerateDebugInformation>
      <EnableCOMDATFolding Condition="'$(FreeBuild)'=='true'">true</EnableCOMDATFolding>
      <OptimizeReferences Condition="'$(FreeBuild)'=='true'">true</OptimizeReferences>
      <IgnoreAllDefaultLibraries>true</IgnoreAllDefaultLibraries>
    </Link>
    <ImpLib>
      <IgnoreAllDefaultLibraries>true</IgnoreAllDefaultLibraries>
      <TreatLinkerWarningAsErrors>true</TreatLinkerWarningAsErrors>
      <GenerateDebugInformation>true</GenerateDebugInformation>
    </ImpLib>    
  </ItemDefinitionGroup>
  <!-- chk build flags -->
  <ItemDefinitionGroup Condition="'$(FreeBuild)'!='true'">
    <ClCompile>
      <!-- ========= From inetcore\jscript\project.mk ========= -->
      <Optimization>Disabled</Optimization>
      <PreprocessorDefinitions>%(PreprocessorDefinitions);_DEBUG;DBG;DBG_DUMP</PreprocessorDefinitions>
    </ClCompile>
  </ItemDefinitionGroup>
  <!-- fre and fretest build flags -->
  <ItemDefinitionGroup Condition="'$(FreeBuild)'=='true'">
    <ClCompile>
      <!-- ========= From inetcore\jscript\project.mk ========= -->
      <PreprocessorDefinitions>%(PreprocessorDefinitions);NDEBUG</PreprocessorDefinitions>      
      <PreprocessorDefinitions Condition="'$(Configuration)'=='fretest'">%(PreprocessorDefinitions);ENABLE_DEBUG_CONFIG_OPTIONS=1</PreprocessorDefinitions>
      <Optimization>MaxSpeed</Optimization>    
      <WholeProgramOptimization>true</WholeProgramOptimization>
    </ClCompile>
  </ItemDefinitionGroup>
  <!-- CFG - From tools\makefile.def -->
  <ItemDefinitionGroup Condition="'$(CFG)'=='true'">
    <ClCompile>
      <PreprocessorDefinitions>%(PreprocessorDefinitions);_CONTROL_FLOW_GUARD=1;_CONTROL_FLOW_GUARD_SVCTAB=1</PreprocessorDefinitions>
      <AdditionalOptions>%(AdditionalOptions) /d2guard4 /d2nocfgrngchk /d2guardcfgfuncptr</AdditionalOptions>
      <AdditionalOptions Condition="'$(Platform)'=='Win32'">/d2guardcheckesp2 %(AdditionalOptions)</AdditionalOptions>
      <AdditionalOptions Condition="'$(Platoform)'!='ARM' and '$(Platform)'!='Arm64'">%(AdditionalOptions) /d2psvcallopt150000</AdditionalOptions>
    </ClCompile>
    <MASM>
      <PreprocessorDefinitions>%(PreprocessorDefinitions);_CONTROL_FLOW_GUARD=1;_CONTROL_FLOW_GUARD_SVCTAB=1</PreprocessorDefinitions>
    </MASM>
    <Link>
      <AdditionalOptions>%(AdditionalOptions) /guard:export /guard:mixed /d2:-guardcfgfuncptr</AdditionalOptions>
    </Link>
  </ItemDefinitionGroup>

  <Import Condition="'$(BuildingWithBuildExe)'=='true'" Project="Chakra.Build.Razzle.props" />
  <Import Condition="'$(BuildingWithBuildExe)'!='true'" Project="Chakra.Build.Solution.props" />
</Project>
